# Deployment on Openshift

This application is deployed on Openshift. This readme will outline how to setup and configure an Openshift project to get the application to a deployable state. This document assumes a working knowledge of Kubernetes/Openshift container orchestration concepts (i.e. buildconfigs, deployments, imagestreams, secrets, configmaps, routes, networkpolicies, etc) and Red Hat SSO authentication.

Our CI/CD pipelines are orchestrated by [GitHub Actions](../.github/workflows).

## Table of Contents

- [Openshift Deployment Prerequisites](#openshift-deployment-prerequisites)
- [Environment Setup - ConfigMaps and Secrets](#environment-setup---configmaps-and-secrets)
- [Deployment](#deployment)

## Openshift Deployment Prerequisites

We assume you are logged into OpenShift.

### Patroni Deployment

Follow the instructions provided in [nr-patroni-chart](https://github.com/bcgov/nr-patroni-chart) to to deploy a patroni cluster.

### Add ImageStream in the tools namespace

Before deploying, ensure that you have the Image Stream `medis-rls` copying the YAML from [app.image-stream](./app.image-stream.yaml) to the "Create ImageStream" page.

### Add Default Kubernetes Network Policies

Before deploying, ensure that you have the Network Policy `allow-from-openshift-ingress` copying the YAML from [allow-from-openshift-ingress](./allow-from-openshift-ingress.np.yaml) to the "Create NetworkPolicy" page.

## Environment Setup - ConfigMaps and Secrets

There are some requirements in the target Openshift namespace/project which are **outside** of the CI/CD pipeline process. This application requires that a few Secrets as well as ConfigMaps are already present in the environment before it is able to function as intended. Otherwise the pipeline will fail the deployment by design.

### ConfigMaps

Go to the +Add screen in OpenShift and copy all from [app.cm](./app.cm.yaml), and add the appropriate values left empty under each data section. These values can be collected from your S3 provider and your Keycloak SSO provider.

### Secrets

Go to the +Add screen in OpenShift and copy all from [app.secret](./app.secret.yaml), and add the appropriate values left empty under each data section. These values can be collected from your S3 provider and your Keycloak SSO provider.

For _medis-rls-secret_, generate 2 random 32-char alphanumeric strings using `openssl rand -base64` or similar commands, and use them as the externalapikey and webhooksecret. mailapitoken is the CHES secrets which can be collected from your CHES integrations.

## Deployment

This application is currently designed as a single application pod deployment. It will host a static frontend containing all of the Vue.js resources and assets, and a Node.js backend which serves the API that the frontend requires. We are currently leveraging Openshift Routes with path based filtering to forward incoming traffic to the right deployment service.

### Application

The backend is a standard [Node](https://nodejs.org)/[Express](https://expressjs.com) server. It handles the JWT based authentication via OIDC authentication flow, and exposes the API to authorized users. This deployment container is built up on top of an Alpine Node image. The resulting container after build is what is deployed.

Go to the +Add screen in OpenShift and copy all from [app.d](./app.d.yaml), using the copy and replace, replace the following values with the value described:

- ${{ IMAGE_TAG }}: the image tag
- ${{ ENVIRONMENT }}: the environment you're deploying to
- ${{ TOOL_NAMESPACE }}: the tools namespace name
- ${{ DATABASE_SECRET_NAME }}: the database secret generated by the Patroni Helm deployment
- ${{ IMAGE_LINK }}: Internal link to the initial image, this can be created using 'image-registry.openshift-image-registry.svc:5000/${{ TOOL_NAMESPACE }}/medis-rls:${{ IMAGE_TAG }}'
